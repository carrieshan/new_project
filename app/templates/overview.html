{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- 左侧数据库列表 -->
    <div class="col-md-3">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span><i class="bi bi-database me-2"></i>数据库列表</span>
                </div>
                <input type="text" class="form-control form-control-sm" id="tableSearchInput" placeholder="搜索数据库或表名...">
            </div>
            <div class="list-group list-group-flush overflow-auto" id="dbList" style="max-height: calc(100vh - 200px);">
                <div class="text-center py-3 text-muted">加载中...</div>
            </div>
        </div>
    </div>
    
    <!-- 右侧数据展示 -->
    <div class="col-md-9">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary" id="currentTableTitle">
                    <i class="bi bi-info-circle me-2"></i>请选择表查看数据
                </h5>
            </div>
            <div class="card-body p-0 d-flex flex-column">
                <div class="table-responsive flex-grow-1" id="tableContent" style="min-height: 400px; max-height: calc(100vh - 250px);">
                    <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                        <div class="text-center">
                            <i class="bi bi-table display-1 text-light"></i>
                            <p class="mt-3">请从左侧列表选择一个表</p>
                        </div>
                    </div>
                </div>
                
                <!-- 分页 -->
                <div class="card-footer bg-white border-top py-2" id="paginationContainer" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small text-muted" id="pageInfo"></div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item" id="prevPage">
                                    <a class="page-link" href="#" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item" id="nextPage">
                                    <a class="page-link" href="#" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentDbId = null;
    let currentTable = null;
    let currentOffset = 0;
    const limit = 20;
    let currentTotal = 0;
    let currentFilters = {};

    $(document).ready(function() {
        loadDatabases();
        
        // 左侧列表搜索功能
        $('#tableSearchInput').on('input', function() {
            const value = $(this).val().toLowerCase().trim();
            
            // 遍历所有数据库项
            $('#dbList > .list-group-item').each(function() {
                const dbItem = $(this);
                const dbName = dbItem.text().toLowerCase();
                
                // 获取对应的表容器ID
                const onClick = dbItem.attr('onclick');
                if (!onClick) return;
                const match = onClick.match(/toggleTables\((\d+)/);
                if (!match) return;
                const dbId = match[1];
                
                const tablesContainer = $(`#tables-${dbId}`);
                const tables = tablesContainer.find('a');
                
                let matchDb = dbName.indexOf(value) > -1;
                let hasMatchingTable = false;
                
                // 如果表已经加载，检查其中的表名
                if (tables.length > 0) {
                    tables.each(function() {
                        const tableItem = $(this);
                        const tableName = tableItem.text().toLowerCase();
                        if (tableName.indexOf(value) > -1) {
                            tableItem.show();
                            hasMatchingTable = true;
                        } else {
                            tableItem.hide();
                        }
                    });
                }
                
                // 显示逻辑
                if (value === '') {
                    dbItem.show();
                    tables.show();
                } else if (hasMatchingTable) {
                    dbItem.show();
                    // 展开
                    if (!tablesContainer.hasClass('show')) {
                        // 使用 Bootstrap collapse
                        const bsCollapse = new bootstrap.Collapse(tablesContainer[0], {toggle: false});
                        bsCollapse.show();
                        $(`#icon-${dbId}`).removeClass('bi-chevron-down').addClass('bi-chevron-up');
                    }
                } else if (matchDb) {
                    dbItem.show();
                    // 如果只匹配数据库名，不强制展开
                } else {
                    dbItem.hide();
                }
            });
        });

        $('#prevPage').click(function(e) {
            e.preventDefault();
            if (!$(this).hasClass('disabled')) {
                currentOffset -= limit;
                loadTableData();
            }
        });
        
        $('#nextPage').click(function(e) {
            e.preventDefault();
            if (!$(this).hasClass('disabled')) {
                currentOffset += limit;
                loadTableData();
            }
        });

        $(document).on('click', '.apply-filter', function(e) {
            e.stopPropagation();
            const col = $(this).data('col');
            const input = $(this).closest('.dropdown-menu').find('input');
            const val = input.val().trim();
            
            if (val) {
                currentFilters[col] = val;
            } else {
                delete currentFilters[col];
            }
            
            currentOffset = 0;
            loadTableData();
        });
        
        $(document).on('click', '.clear-filter', function(e) {
            e.stopPropagation();
            const col = $(this).data('col');
            delete currentFilters[col];
            currentOffset = 0;
            loadTableData();
        });
        
        $(document).on('keypress', '.filter-input', function(e) {
            if (e.which === 13) {
                $(this).closest('.dropdown-menu').find('.apply-filter').click();
            }
        });
    });

    function loadDatabases() {
        $.get('/api/databases', function(data) {
            if (data.length === 0) {
                $('#dbList').html('<div class="text-center py-3 text-muted">暂无数据库配置</div>');
                return;
            }
            
            let html = '';
            data.forEach(db => {
                html += `
                    <div class="list-group-item list-group-item-action bg-light fw-bold" 
                         style="cursor: pointer;" 
                         onclick="toggleTables(${db.id}, this)">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-hdd-stack me-2"></i>${db.name}</span>
                            <i class="bi bi-chevron-down small text-muted transition-icon" id="icon-${db.id}"></i>
                        </div>
                    </div>
                    <div class="list-group list-group-flush collapse" id="tables-${db.id}">
                        <div class="text-center py-2 small text-muted">加载表列表中...</div>
                    </div>
                `;
            });
            $('#dbList').html(html);
        });
    }

    function toggleTables(dbId, element) {
        const container = $(`#tables-${dbId}`);
        const icon = $(`#icon-${dbId}`);
        
        // 使用 Bootstrap collapse 实例或 jQuery 方法
        // 这里直接用 jQuery 的 collapse 方法，前提是 bootstrap.js 已加载
        if (container.hasClass('show')) {
            container.collapse('hide');
            icon.removeClass('bi-chevron-up').addClass('bi-chevron-down');
        } else {
            container.collapse('show');
            icon.removeClass('bi-chevron-down').addClass('bi-chevron-up');
            
            // 如果还没有加载过或者显示加载中
            if (container.find('.text-muted').length > 0 || container.children().length === 0) {
                loadTables(dbId);
            }
        }
    }

    function loadTables(dbId) {
        $.get(`/api/databases/${dbId}/tables`, function(response) {
            if (response.status === 'success') {
                if (response.tables.length === 0) {
                    $(`#tables-${dbId}`).html('<div class="text-center py-2 small text-muted">无表</div>');
                    return;
                }
                
                let html = '';
                response.tables.forEach(table => {
                    html += `
                        <a href="javascript:void(0)" 
                           class="list-group-item list-group-item-action ps-4 py-2 small border-0" 
                           onclick="selectTable(${dbId}, '${table}', this)">
                            <i class="bi bi-table me-2 text-secondary"></i>${table}
                        </a>`;
                });
                $(`#tables-${dbId}`).html(html);
            } else {
                $(`#tables-${dbId}`).html(`<div class="text-danger small p-2">加载失败: ${response.message}</div>`);
            }
        });
    }

    function selectTable(dbId, tableName, element) {
        // Highlight selection
        $('.list-group-item-action').removeClass('active text-white');
        
        // 恢复所有 icon 颜色
        $('.bi-table').removeClass('text-white').addClass('text-secondary');
        
        $(element).addClass('active text-white');
        $(element).find('i').removeClass('text-secondary').addClass('text-white');
        
        currentDbId = dbId;
        currentTable = tableName;
        currentOffset = 0;
        currentFilters = {};
        
        $('#currentTableTitle').html(`<i class="bi bi-table me-2"></i>${tableName}`);
        
        loadTableData();
    }

    function loadTableData() {
        $('#tableContent').html(`
            <div class="d-flex flex-column align-items-center justify-content-center h-100">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">正在加载数据...</p>
            </div>
        `);
        
        $.get(`/api/databases/${currentDbId}/tables/${currentTable}/data`, {
            limit: limit,
            offset: currentOffset,
            filters: JSON.stringify(currentFilters)
        }, function(response) {
            if (response.status === 'success') {
                currentTotal = response.total;
                renderTable(response);
                updatePagination();
            } else {
                $('#tableContent').html(`
                    <div class="alert alert-danger m-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>加载数据失败: ${response.message}
                    </div>
                `);
                $('#paginationContainer').hide();
            }
        }).fail(function() {
            $('#tableContent').html(`
                <div class="alert alert-danger m-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>网络请求失败
                </div>
            `);
            $('#paginationContainer').hide();
        });
    }

    function renderTable(data) {
        if (!data.rows || data.rows.length === 0) {
            $('#tableContent').html(`
                <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                    <div class="text-center">
                        <i class="bi bi-inbox display-4"></i>
                        <p class="mt-2">暂无数据</p>
                    </div>
                </div>
            `);
            return;
        }

        let html = '<table class="table table-striped table-hover table-bordered mb-0" style="font-size: 0.9rem;">';
        
        // Header
        html += '<thead class="table-light sticky-top"><tr>';
        // Add row number column
        html += '<th style="width: 50px;">#</th>';
        data.columns.forEach(col => {
            const hasFilter = currentFilters[col] ? 'text-primary' : 'text-muted';
            const filterValue = currentFilters[col] || '';
            
            html += `
                <th style="min-width: 150px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-truncate" title="${col}">${col}</span>
                        <div class="dropdown">
                            <i class="bi bi-funnel-fill ${hasFilter}" 
                               data-bs-toggle="dropdown" 
                               data-bs-auto-close="outside" 
                               style="cursor: pointer;"
                               title="筛选"></i>
                            <div class="dropdown-menu p-2 shadow" style="min-width: 200px;">
                                <div class="mb-2 small fw-bold">筛选 ${col}</div>
                                <input type="text" class="form-control form-control-sm mb-2 filter-input" 
                                       data-col="${col}" 
                                       value="${filterValue}" 
                                       placeholder="输入关键词...">
                                <div class="d-flex justify-content-end gap-2">
                                    <button class="btn btn-sm btn-light border clear-filter" data-col="${col}">清除</button>
                                    <button class="btn btn-sm btn-primary apply-filter" data-col="${col}">应用</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </th>`;
        });
        html += '</tr></thead>';
        
        // Body
        html += '<tbody>';
        data.rows.forEach((row, index) => {
            html += '<tr>';
            html += `<td class="text-muted text-center">${currentOffset + index + 1}</td>`;
            row.forEach(cell => {
                let displayVal;
                if (cell === null) {
                    displayVal = '<span class="badge bg-light text-dark border">NULL</span>';
                } else {
                    const text = String(cell);
                    // 简单的 HTML 转义
                    displayVal = text.replace(/&/g, "&amp;")
                                     .replace(/</g, "&lt;")
                                     .replace(/>/g, "&gt;")
                                     .replace(/"/g, "&quot;")
                                     .replace(/'/g, "&#039;");
                    // 截断过长文本
                    if (displayVal.length > 100) {
                        displayVal = `<span title="${displayVal}">${displayVal.substring(0, 100)}...</span>`;
                    }
                }
                html += `<td>${displayVal}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        
        $('#tableContent').html(html);
    }

    function updatePagination() {
        const totalPages = Math.ceil(currentTotal / limit);
        const currentPage = Math.floor(currentOffset / limit) + 1;
        
        $('#pageInfo').html(`显示第 <b>${currentOffset + 1}</b> - <b>${Math.min(currentOffset + limit, currentTotal)}</b> 条，共 <b>${currentTotal}</b> 条`);
        
        if (currentOffset <= 0) {
            $('#prevPage').addClass('disabled');
        } else {
            $('#prevPage').removeClass('disabled');
        }
        
        if (currentOffset + limit >= currentTotal) {
            $('#nextPage').addClass('disabled');
        } else {
            $('#nextPage').removeClass('disabled');
        }
        
        $('#paginationContainer').show();
    }
</script>
{% endblock %}