{% extends 'base.html' %}

{% block content %}
<h2>数据库配置</h2>

<div class="row mb-3">
    <div class="col-md-12">
        <button class="btn btn-primary" onclick="openAddDbModal()">添加数据库</button>
    </div>
</div>

<table class="table table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>名称</th>
            <th>类型</th>
            <th>主机</th>
            <th>端口</th>
            <th>数据库名</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody id="dbTableBody">
        <!-- 数据库列表将在这里动态加载 -->
    </tbody>
</table>

<!-- 添加/编辑数据库模态框 -->
<div class="modal fade" id="addDbModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dbModalTitle">添加数据库</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addDbForm">
                    <input type="hidden" name="id" id="dbEditId">
                    <div class="mb-3">
                        <label class="form-label">名称</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">类型</label>
                        <select class="form-select" name="db_type" required>
                            <option value="mysql">MySQL</option>
                            <option value="postgresql">PostgreSQL</option>
                            <option value="sqlite">SQLite</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">主机 (Host)</label>
                        <input type="text" class="form-control" name="host">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">端口 (Port)</label>
                        <input type="number" class="form-control" name="port">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">用户名</label>
                        <input type="text" class="form-control" name="username">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">密码</label>
                        <input type="password" class="form-control" name="password">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">数据库名</label>
                        <input type="text" class="form-control" name="database">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-info" onclick="testConnection()">测试连接</button>
                <button type="button" class="btn btn-primary" onclick="saveDatabase()">保存</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let allDatabases = [];

    function loadDatabases() {
        $.get('/api/databases', function (data) {
            allDatabases = data;
            let html = '';
            data.forEach(db => {
                html += `<tr>
                    <td>${db.id}</td>
                    <td>${db.name}</td>
                    <td><span class="badge bg-info">${db.type}</span></td>
                    <td>${db.host || '-'}</td>
                    <td>${db.port || '-'}</td>
                    <td>${db.database || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editDatabase(${db.id})">
                            <i class="bi bi-pencil"></i> 编辑
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDatabase(${db.id})">
                            <i class="bi bi-trash"></i> 删除
                        </button>
                    </td>
                </tr>`;
            });
            if (data.length === 0) {
                html = '<tr><td colspan="7" class="text-center text-muted">暂无数据库配置</td></tr>';
            }
            $('#dbTableBody').html(html);
        });
    }

    function openAddDbModal() {
        $('#dbEditId').val('');
        $('#addDbForm')[0].reset();
        $('#dbModalTitle').text('添加数据库');
        new bootstrap.Modal(document.getElementById('addDbModal')).show();
    }

    function editDatabase(id) {
        const db = allDatabases.find(d => d.id === id);
        if (!db) return;

        $('#dbEditId').val(db.id);
        $('#addDbForm [name="name"]').val(db.name);
        $('#addDbForm [name="db_type"]').val(db.type);
        $('#addDbForm [name="host"]').val(db.host);
        $('#addDbForm [name="port"]').val(db.port);
        $('#addDbForm [name="database"]').val(db.database);
        // 密码和用户名不回填（安全考虑），如需修改需重新输入
        $('#addDbForm [name="username"]').val('');
        $('#addDbForm [name="password"]').val('');

        $('#dbModalTitle').text('编辑数据库');
        new bootstrap.Modal(document.getElementById('addDbModal')).show();
    }

    function deleteDatabase(id) {
        const db = allDatabases.find(d => d.id === id);
        if (!confirm(`确定要删除数据库 "${db ? db.name : id}" 吗？`)) return;

        $.ajax({
            url: `/api/databases/${id}`,
            type: 'DELETE',
            success: function (response) {
                if (response.status === 'success') {
                    showToast('数据库已删除');
                    loadDatabases();
                } else {
                    showToast(response.message || '删除失败', 'error');
                }
            },
            error: function (xhr) {
                showToast(xhr.responseJSON ? xhr.responseJSON.message : '删除失败', 'error');
            }
        });
    }

    function testConnection() {
        let formData = {};
        $('#addDbForm').serializeArray().forEach(item => {
            formData[item.name] = item.value;
        });

        $.ajax({
            url: '/api/databases/test',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function (response) {
                if (response.status === 'success') {
                    showToast('连接成功！');
                } else {
                    showToast('连接失败：' + response.message, 'error');
                }
            },
            error: function (xhr, status, error) {
                showToast('请求失败：' + error, 'error');
            }
        });
    }

    function saveDatabase() {
        let formData = {};
        $('#addDbForm').serializeArray().forEach(item => {
            formData[item.name] = item.value;
        });

        const editId = $('#dbEditId').val();
        const method = editId ? 'PUT' : 'POST';
        const url = editId ? `/api/databases/${editId}` : '/api/databases';

        $.ajax({
            url: url,
            type: method,
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function (response) {
                if (response.status === 'success') {
                    const modalEl = document.getElementById('addDbModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                    showToast(editId ? '数据库配置已更新' : '数据库已添加');
                    loadDatabases();
                } else {
                    showToast(response.message || '保存失败', 'error');
                }
            },
            error: function (xhr) {
                showToast(xhr.responseJSON ? xhr.responseJSON.message : '保存失败', 'error');
            }
        });
    }

    $(document).ready(function () {
        loadDatabases();
    });
</script>
{% endblock %}